<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOT Bank</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Share+Tech&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="Style/bankstyle.css" />
</head>

<body>

  
  <div class="container">
    <div class="horizontal">
      <h3>Prime Card</h3>
      <h2 class="USDFont" id="welcomeMessage">Loading...</h2>
    </div>

    <br>
    <div class="info2">
      <span id="cardNumber" class="cardNumber">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
      
    </div>
    <br>
    <div class="info">
      <span class="USDFont">$</span>
      <span class="USDFont" id="balance">0</span>
    </div>
  </div>

  <div class="container2">
    <button id="openModalButton">
      <img class="SendLogo" src="Logos/ControlPanel/send (1).png" alt="">
    </button>
    
    <button id="openDragonButton">
      <img class="SendLogo" src="DragonArts/levelUpLogo.png" alt="">
    </button>
    
    <button id="openShopButton">
      <img class="SendLogo" src="Logos/shopicon.png" alt="">
    </button>
  </div>

  <div class="transferHistory">
    <h3>Transfer History</h3>
  </div>

  <div id="shopModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Shop</span>
        <div class="modal-close" id="closeShopModalButton">&times;</div>
      </div>
      <div id="productList"></div>
    </div>
  </div>

  <div id="dragonModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
        <img src="DragonArts/Egg.png" alt="Dragon Icon" style="width: 60px; margin-bottom: 0;">
        <h5 style="margin:0;">Dragon menu üêâ</h5>
        <div class="modal-close" id="closeDragonModal" style="margin-left:10px;">&times;</div>
      </div>

      <div class="dragon-area" id="dragonArea">
        <button id="createDragonBtn" class="small-btn" style="margin-top:12px;">Create Dragon</button>
        <div id="dragonUI" style="width:100%; display:none;">
          <div class="dragon-image" id="dragonImage">
            <img src="DragonArts/Egg.png" alt="Dragon Icon" style="width: 300px; margin-bottom: 15px;">
          </div>
          <div class="dragon-stats">
            <div id="dragonLevel">Level: ‚Äî</div>
            <div id="dragonXP">XP: 0 / 500</div>
          </div>
          <div class="progress-wrapper">
            <div id="dragonProgress" class="progress-bar" style="width:0%"></div>
          </div>
          <div class="dragon-controls">
            <button id="debugAddXP" class="small-btn" style="display:none;">+100 XP (debug)</button>
            <button id="hatchBtn" class="small-btn" style="display:none;">Force Hatch (debug)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="productDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-close" id="closeProductDetail">&times;</div>
      <img id="detailImage" src="" alt="Product" style="width:100%; border-radius: 15px; margin-bottom: 15px;">
      <h5 id="detailName"></h5>
      <p id="detailDescription"></p>
      <h5 id="detailPrice"></h5>
      <button id="buyButton" class="buttonSend">–ü—Ä–∏–¥–±–∞—Ç–∏</button>
    </div>
  </div>

  <div id="transactionModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="modal-close" id="closeTransactionModal">&times;</div>
      <img src="Logos/ControlPanel/send (1).png" alt="" style="width: 150px; margin-bottom: 20px;">
      <h2 id="txAmount" style="font-size: 28px; margin-bottom: 15px; color: #333;"></h2>
      <h3 id="txFrom" style="margin-bottom: 10px; color: #555;"></h3>
      <p id="txTime" style="color: #383838; font-size: 14px;"></p>
    </div>
  </div>

  <div id="transferModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Send Money</span>
        <div class="modal-close" id="closeModalButton">&times;</div>
      </div>
      <form id="transferForm">
        <label for="targetCard">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∏:</label>
        <input type="text" id="targetCard" maxlength="16" placeholder="Enter 16-digit card" required />
        <label for="amount">–°—É–º–∞ –ø–µ—Ä–µ–∫–∞–∑—É:</label>
        <input type="number" id="amount" min="0.01" step="0.01" placeholder="Enter amount" required />
        <button class="buttonSend" type="submit">Send</button>
      </form>
    </div>
  </div>

  <script type="module">

    import { auth, db } from './Scripts/firebase.js';
    import {
      doc,
      getDoc,
      collection,
      getDocs,
      updateDoc,
      addDoc,
      serverTimestamp,
      query,
      where,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const ADMIN_ID = 6291318550;
    const discordWebhookUrl = "https://discord.com/api/webhooks/1418546486681145434/emWkQYRc5puI-fGDJD9sG24pYt-3B3_YZV2GHrr1Hd7cA9g1OLbWdNTsQZ1vZX9t3VaR";

    const productList = document.getElementById("productList");
    const productDetailModal = document.getElementById("productDetailModal");
    const detailImage = document.getElementById("detailImage");
    const detailName = document.getElementById("detailName");
    const detailDescription = document.getElementById("detailDescription");
    const detailPrice = document.getElementById("detailPrice");
    const buyButton = document.getElementById("buyButton");
    let selectedProduct = null;

    async function loadProducts() {
      try {
        const productsSnapshot = await getDocs(collection(db, "products"));
        const products = [];
        productsSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          products.push({ id: docSnap.id, ...data });
        });
        return products;
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:", error);
        alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤!");
        return [];
      }
    }

    async function displayProducts() {
      productList.innerHTML = "";
      const products = await loadProducts();
      
      if (products.length === 0) {
        productList.innerHTML = "<p style='color:#333; text-align:center;'>–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ —É –º–∞–≥–∞–∑–∏–Ω—ñ.</p>";
        return;
      }

      products.forEach(prod => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #ccc";
        div.style.cursor = "pointer";

        div.innerHTML = `
          <img src="${prod.image || 'Logos/Shop/default.png'}" style="width:60px; height:60px; border-radius:10px; margin-right:10px;">
          <div>
            <h4 style="margin:0; color:#333;">${prod.name}</h4>
            <p style="margin:0; font-size:14px; color:#655;">${prod.description}</p>
            <strong style="color:#000;">${prod.price} HOT</strong>
          </div>
        `;

        div.addEventListener("click", () => {
          selectedProduct = prod;
          detailImage.src = prod.image || 'Logos/Shop/default.png';
          detailName.innerText = prod.name;
          detailDescription.innerText = prod.description;
          detailPrice.innerText = `${prod.price} HOT`;
          productDetailModal.style.display = "flex";
        });

        productList.appendChild(div);
      });
    }

    document.getElementById("openShopButton").addEventListener("click", () => {
      document.getElementById("shopModal").style.display = "flex";
      displayProducts();
    });
   
    document.getElementById("closeProductDetail").addEventListener("click", () => {
      productDetailModal.style.display = "none";
    });

    buyButton.addEventListener("click", async () => {
      if (!selectedProduct) return;

      const userRef = doc(db, "users", auth.currentUser.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        alert("–ü–æ–º–∏–ª–∫–∞: –ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π!");
        return;
      }

      const userData = userSnap.data();

      if (userData.balance < selectedProduct.price) {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!");
        return;
      }

      await updateDoc(userRef, {
        balance: userData.balance - selectedProduct.price
      });

      await addDoc(collection(db, "transfers"), {
        from: userData.username,
        to: `Shop (${selectedProduct.name})`,
        amount: selectedProduct.price,
        timestamp: serverTimestamp(),
        type: "shop"
      });

      const discordPayload = {
        embeds: [
          {
            title: "üõí –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è",
            description: `**–ü–æ–∫—É–ø–µ—Ü—å:** ${userData.username}\n**–¢–æ–≤–∞—Ä:** ${selectedProduct.name}\n**–¶—ñ–Ω–∞:** ${selectedProduct.price} HOT\n**–ê—Ä—Ç–∏–∫—É–ª:** ${selectedProduct.article}`,
            color: 0x4CAF50,
            timestamp: new Date().toISOString()
          }
        ]
      };

      fetch(discordWebhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(discordPayload)
      });

      alert("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø—ñ—à–Ω–∞!");
      location.reload();
    });

    
    const DRAGON_STAGE_IMAGES = [
      "DragonArts/Egg.png",
      "DragonArts/Stage1.png",
      "DragonArts/Stage2.png",
      "DragonArts/Stage3.png",
      "DragonArts/Stage4.png",
      "DragonArts/Stage5.png"
    ];
    const MAX_DRAGON_LVL = 5; 

    function xpThresholdForLevel(lvl) {
      return 500 * Math.pow(2, lvl);
    }

    const createDragonBtn = document.getElementById("createDragonBtn");
    const dragonModal = document.getElementById("dragonModal");
    const openDragonButton = document.getElementById("openDragonButton");
    const closeDragonModal = document.getElementById("closeDragonModal");
    const dragonUI = document.getElementById("dragonUI");
    const dragonImage = document.getElementById("dragonImage").querySelector("img");
    const dragonLevelEl = document.getElementById("dragonLevel");
    const dragonXPEl = document.getElementById("dragonXP");
    const dragonProgress = document.getElementById("dragonProgress");
    const debugAddXP = document.getElementById("debugAddXP");
    const hatchBtn = document.getElementById("hatchBtn");

    let currentUserDocRef = null;
    let unsubscribeDragonListener = null;

    async function createDragonForUser(userUid, username) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        alert("–ü—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.");
        return;
      }
      const userData = userSnap.data();

      if (userData.dragon && typeof userData.dragon === "object") {
        alert("–£ –≤–∞—Å –≤–∂–µ —î –¥—Ä–∞–∫–æ–Ω!");
        return;
      }

      const dragonObj = {
        xp: 0,
        lvl: 0,
        createdAt: serverTimestamp()
      };

      await updateDoc(userRef, {
        dragon: dragonObj
      });

      alert("–î—Ä–∞–∫–æ–Ω —Å—Ç–≤–æ—Ä–µ–Ω–∏–π! –ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—ñ–¥–ª—ñ–∫ XP (0/500).");
    }

    function renderDragonUI(dragon) {
      if (!dragon) {
        dragonUI.style.display = "none";
        createDragonBtn.style.display = "inline-block";
        return;
      }

      createDragonBtn.style.display = "none";
      dragonUI.style.display = "block";

      const lvl = typeof dragon.lvl === "number" ? dragon.lvl : 0;
      let xp = typeof dragon.xp === "number" ? dragon.xp : 0;

      const nextThreshold = xpThresholdForLevel(lvl);
      const progressPercent = Math.min(100, Math.round((xp / nextThreshold) * 100));

      const stageIndex = Math.min(lvl, MAX_DRAGON_LVL);
      const imgPath = DRAGON_STAGE_IMAGES[stageIndex] || DRAGON_STAGE_IMAGES[0];

      dragonImage.src = imgPath;
      dragonLevelEl.innerText = `Level: ${lvl} ${lvl === 0 ? "(egg)" : ""}`;
      dragonXPEl.innerText = `XP: ${xp} / ${nextThreshold}`;
      dragonProgress.style.width = progressPercent + "%";

      if (lvl >= MAX_DRAGON_LVL) {
        dragonXPEl.innerText = `XP: ${xp} (MAX)`;
        dragonProgress.style.width = "100%";
      }
    }

    function watchUserDragon(userUid) {
      if (unsubscribeDragonListener) {
        unsubscribeDragonListener();
        unsubscribeDragonListener = null;
      }
      currentUserDocRef = doc(db, "users", userUid);
      unsubscribeDragonListener = onSnapshot(currentUserDocRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        renderDragonUI(data.dragon);
      });
    }

    async function normalizeDragonLevels(userUid) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();
      if (!data.dragon) return;

      let { xp = 0, lvl = 0 } = data.dragon;
      let changed = false;

      while (lvl < MAX_DRAGON_LVL) {
        const threshold = xpThresholdForLevel(lvl);
        if (xp >= threshold) {
          xp = xp - threshold;
          lvl = lvl + 1;
          changed = true;
        } else break;
      }

      if (changed) {
        await updateDoc(userRef, {
          "dragon.xp": xp,
          "dragon.lvl": lvl,
          "dragon.lastLevelUpAt": serverTimestamp()
        });
      }
    }

    async function addXPtoDragon(userUid, amount) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();
      if (!data.dragon) {
        alert("–î—Ä–∞–∫–æ–Ω –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ.");
        return;
      }
      const newXP = (data.dragon.xp || 0) + amount;
      await updateDoc(userRef, {
        "dragon.xp": newXP
      });
      await normalizeDragonLevels(userUid);
    }

    openDragonButton.addEventListener('click', () => {
      dragonModal.style.display = 'flex';
    });
    closeDragonModal.addEventListener('click', () => {
      dragonModal.style.display = 'none';
    });

    createDragonBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) { alert("–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å."); return; }
      await createDragonForUser(user.uid);
    });

    debugAddXP.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      await addXPtoDragon(user.uid, 100);
    });
    hatchBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      await addXPtoDragon(user.uid, 10000);
    });

    async function loadTransfers(username) {
      const transferHistoryDiv = document.querySelector(".transferHistory");
      transferHistoryDiv.innerHTML = "<h3>Transfer History</h3>";

      const incomingQuery = query(collection(db, "transfers"), where("to", "==", username));
      const outgoingQuery = query(collection(db, "transfers"), where("from", "==", username));

      const [incomingSnapshot, outgoingSnapshot] = await Promise.all([getDocs(incomingQuery), getDocs(outgoingQuery)]);

      const transfers = [];

      incomingSnapshot.forEach(docSnap => { let data = docSnap.data(); data.type = "incoming"; transfers.push(data); });
      outgoingSnapshot.forEach(docSnap => { let data = docSnap.data(); data.type = "outgoing"; transfers.push(data); });

      transfers.sort((a, b) => {
        const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
        const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
        return timeB - timeA;
      });

      transfers.forEach(transfer => {
        const p = document.createElement("p");
        p.classList.add("transfer-message");

        if (transfer.type === "incoming") {
          p.classList.add("incoming");
          p.innerHTML = `${transfer.from} sent you ${transfer.amount}  <span class="USDFont">$</span>`;

          p.addEventListener("click", () => {
            document.getElementById("transactionModal").style.display = "flex";
            document.getElementById("txAmount").innerText = `${transfer.amount} HOT`;
            document.getElementById("txFrom").innerText = `–í—ñ–¥: ${transfer.from}`;
            document.getElementById("txTime").innerText = transfer.timestamp
              ? `–ß–∞—Å: ${transfer.timestamp.toDate().toLocaleString()}`
              : "–ß–∞—Å: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
          });
        } else {
          p.classList.add("outgoing");
          p.innerHTML = `You sent ${transfer.amount}  <span class="USDFont">$</span> to ${transfer.to}`;
        }

        transferHistoryDiv.appendChild(p);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();

      document.getElementById('welcomeMessage').innerText = `${data.username}`;
      document.getElementById('balance').innerText = `${data.balance.toFixed(2)}`;
      document.getElementById('cardNumber').innerText = data.cardNumber.replace(/(\d{4})(?=\d)/g, "$1 ");

      document.getElementById('openModalButton').addEventListener('click', () => document.getElementById('transferModal').style.display = 'flex');
      document.getElementById('closeModalButton').addEventListener('click', () => document.getElementById('transferModal').style.display = 'none');
      document.getElementById('closeShopModalButton').addEventListener('click', () => document.getElementById('shopModal').style.display = 'none');
      document.getElementById("closeTransactionModal").addEventListener("click", () => {
        document.getElementById("transactionModal").style.display = "none";
      });

      loadTransfers(data.username);

      document.getElementById('transferForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const targetCard = document.getElementById('targetCard').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        if (targetCard.length !== 16 || isNaN(amount) || amount <= 0) { alert('Invalid input'); return; }

        const usersSnap = await getDocs(collection(db, "users"));
        let recipientId = null, recipientBalance = 0;
        usersSnap.forEach(docSnap => {
          const userDataSnap = docSnap.data();
          if (userDataSnap.cardNumber === targetCard) {
            recipientId = docSnap.id;
            recipientBalance = userDataSnap.balance;
          }
        });
        if (!recipientId) { alert("Card not found!"); return; }
        if (data.balance < amount) { alert("Insufficient funds!"); return; }

        await updateDoc(doc(db, "users", user.uid), { balance: data.balance - amount });
        await updateDoc(doc(db, "users", recipientId), { balance: recipientBalance + amount });

        const recipientRef = doc(db, "users", recipientId);
        const recipientSnap = await getDoc(recipientRef);
        if (recipientSnap.exists()) {
          const recipientData = recipientSnap.data();
          await addDoc(collection(db, "transfers"), {
            from: data.username,
            to: recipientData.username,
            amount: amount,
            timestamp: serverTimestamp()
          });
        }

        alert("Transfer successful!");
        location.reload();
      });

      watchUserDragon(user.uid);
      await normalizeDragonLevels(user.uid);

      if (user.uid === String(ADMIN_ID) || user.uid === ADMIN_ID) {
        debugAddXP.style.display = "inline-block";
        hatchBtn.style.display = "inline-block";
      } else {
        debugAddXP.style.display = "none";
        hatchBtn.style.display = "none";
      }
    });
  </script>

</body>

</html>