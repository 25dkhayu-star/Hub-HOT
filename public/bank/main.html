<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOT Bank</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Share+Tech&display=swap" rel="stylesheet">
  <style>
 


* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Montserrat', sans-serif;
}

body {
  background: #000; /* Black base background */
  background-image: 
    radial-gradient(circle, #fff 1px, transparent 1px); /* White dot grid */
  background-size: 20px 20px; /* Grid size for dots */
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  flex-direction: column;
  
  /* Анимация движения точек вниз */
  background-position: 0 0;
  animation: moveDots 70s linear infinite;
}

@keyframes moveDots {
  0% {
    background-position: 0 0;
  }
  100% {
    background-position: 0 100vh; /* Точки двигаются на высоту экрана вниз */
  }
}

@keyframes gradientFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.container {
  background: rgba(73, 73, 73, 0.418); 
  border: 2px solid rgba(255, 255, 255, 0.25);
  border-radius: 25px;
  width: 420px;
  max-width: 92%;
  padding: 25px;
  position: relative;
  overflow: hidden;
  transform: scale(0.95);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  z-index: 10;
  backdrop-filter: blur(3px);
  margin-bottom: 8px;
  
}

.container:hover {
  transform: scale(1);
  box-shadow: 0 0 5px rgba(129, 129, 129, 0.9), 0 0 80px rgba(255, 255, 255, 0.7);
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 2px rgba(255, 255, 255, 0.7), 0 0 50px rgba(255, 255, 255, 0.5); }
  50% { box-shadow: 0 0 5px rgba(184, 184, 184, 0.9), 0 0 70px rgba(165, 165, 165, 0.7); }
  100% { box-shadow: 0 0 1px rgba(255, 255, 255, 0.7), 0 0 50px rgba(255, 255, 255, 0.5); }
}

.container2 {
  background: rgba(73, 73, 73, 0.418); 
  border-radius: 25px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  width: 420px;
  border: 2px solid rgba(255, 255, 255, 0.25);
  max-width: 92%;
  padding: 20px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(3px);
  display: flex;
  gap: 12px;
  
  transform: scale(0.95);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  z-index: 10;
  margin-bottom: 8px;
 
}

.container2:hover {
  transform: scale(1);
  
}

.transfer-message {
  color: white;
  font-weight: bold;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
  padding: 12px 16px;
  border-radius: 18px;
  backdrop-filter: blur(6px);
  margin: 8px 0;
  font-size: 16px;
  transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
  animation: fadeIn 0.5s ease;
}

.transfer-message:hover {
  transform: translateY(-3px) scale(1.02);
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 25px rgba(255, 255, 255, 0.5);
}

.lycoin {
  width: 18px;
  height: 18px;
  vertical-align: middle;
  margin-left: -2px;
  animation: spinCoin 2s linear infinite;
}

@keyframes spinCoin {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(360deg); }
}

.incoming {
  border-left: 6px solid #ffffff;
  animation: slideInLeft 0.5s ease;
}

.outgoing {
  border-left: 6px solid #8a8a8a;
  animation: slideInRight 0.5s ease;
}

@keyframes slideInLeft {
  from { transform: translateX(-20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInRight {
  from { transform: translateX(20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.nfcLogo {
  width: 32px;
  margin-top: -5px;
  margin-left: 12px;
  transition: transform 0.3s ease;
}

.nfcLogo:hover {
  transform: rotate(360deg);
}

.transferHistory {
  background: rgba(51, 51, 51, 0.418); 
  border-radius: 25px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  width: 420px;
  max-width: 92%;
  border: 2px solid rgba(255, 255, 255, 0.25);
  padding: 25px;
  height: 300px;
  position: relative;
  backdrop-filter: blur(6px);
  overflow-y: scroll;
  transform: scale(0.95);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  z-index: 10;
  margin-bottom: 8px;
}

.transferHistory:hover {
  transform: scale(1);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
}

h2 {
  text-align: center;
  color: #ffffff;
  right: 0;
  font-size: 16px;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
  
}

@keyframes textGlow {
  0% { text-shadow: 0 0 10px rgba(255, 77, 77, 0.7); }
  50% { text-shadow: 0 0 20px rgba(255, 77, 77, 0.9); }
  100% { text-shadow: 0 0 10px rgba(255, 77, 77, 0.7); }
}

h3 {
  color: #ffffff;
  font-size: 22px;
  margin-bottom: 12px;
  text-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
}

.info {
  margin-bottom: 6px;
  font-size: 1.6rem;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 15px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: row;
  padding: 10px;
  backdrop-filter: blur(6px);
  gap: 4px;
  transition: transform 0.3s ease;
}

.info:hover {
  transform: translateY(-2px);
}

.info2 {
  margin-bottom: 6px;
  font-size: 1.5rem;
  text-align: center;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}

label {
  font-weight: 600;
  color: #ffffff;
}

.cardNumber {
  margin-bottom: 22px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  padding: 6px;
  border-radius: 15px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease;
  color: white;
}

.USDFont {
 
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  padding: 5px;
  border-radius: 15px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease;
  color: white;
}

.cardNumber:hover {
  transform: translateY(-2px);
}

input {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  margin-bottom: 18px;
  border-radius: 18px;
  border: none;
  font-size: 1.1rem;
  background: rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  color: white;
  transition: box-shadow 0.3s ease, transform 0.3s ease;
}

input:focus {
  outline: none;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
  transform: scale(1.02);
}

.buttonSend {
   width: 100%;
  padding: 2px;
  border: none;
  background: rgba(255, 255, 255, 0.027);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
  position: relative;
  overflow: hidden;
}
.h5{
  color: white;
}
.buttonSend::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s ease, height 0.6s ease;
}

.buttonSend:hover::before {
  width: 300px;
  height: 300px;
}

.buttonSend:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 255, 255, 0.6);
}

button {
  width: 50%;
  padding: 2px;
  border: none;
  background: rgba(255, 255, 255, 0.027);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
  position: relative;
  overflow: hidden;
}

button:hover {
  background: linear-gradient(45deg, #ffffff, #868686);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(223, 223, 223, 0.6);
}

button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s ease, height 0.6s ease;
}

button:hover::before {
  width: 200px;
  height: 200px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  animation: fadeInModal 0.5s ease;
}

@keyframes fadeInModal {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

@font-face {
  font-family: 'MyFont';
  src: url('/fonts/e-Ukraine-Light.otf') format('woff2');
  font-weight: normal;
  font-style: normal;
}

.modal-content {
  
  background: rgba(73, 73, 73, 0.418); 
  border: 2px solid rgba(255, 255, 255, 0.25);
  border-radius: 25px;
  width: 420px;
  max-width: 92%;
  padding: 25px;
  position: relative;
  overflow: hidden;
  color: white;
  transform: scale(0.95);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
  z-index: 10;
  backdrop-filter: blur(10px);
  margin-bottom: 8px;
  

}

@keyframes slideUpModal {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-content-dragon {
  background: linear-gradient(135deg, #ffffff, #b71c1c);
  border-radius: 25px;
  padding: 35px;
  width: 420px;
  max-width: 92%;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
  animation: slideUpModal 0.5s ease;
}

.LyCoinLogo {
  width: 45px;
  margin-top: -3px;
  animation: bounce 1.5s ease infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.modal-header {
  font-size: 1.6rem;
  margin-bottom: 22px;
  display: flex;
  align-items: center;
  color: white;
  justify-content: center;
  text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
}

.NameStyle {
  margin-bottom: 22px;
  background: rgba(255, 255, 255, 0.5);
  padding: 6px;
  border-radius: 15px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  animation: pulseGlow 2s ease-in-out infinite;
}

.modal-close {
  background: rgba(255, 255, 255, 0.212);
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
  border: none;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 30px;
  font-weight: 700;
  color: #fff;
  cursor: pointer;
  margin-left: auto;
  transition: transform 0.3s ease;
}

.modal-close:hover {
  transform: rotate(90deg);
}

.transferItem {
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  font-size: 1.1rem;
  color: #fff;
  transition: background 0.3s ease;
}

.transferItem:hover {
  background: rgba(255, 77, 77, 0.2);
}

.horizontal {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.LyceumLogo {
  width: 110px;
  height: 30px;
  margin-top: -8px;
  transition: transform 0.3s ease;
}

.LyceumLogo:hover {
  transform: scale(1.1);
}
#balance{
  color: white;
}
.SendLogo {
  width: 55px;
  height: 55px;
  transition: transform 0.3s ease;
}

.SendLogo:hover {
  transform: rotate(360deg);
}


.dragon-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  padding: 12px 0;
  color: #fff;
}

.dragon-image {
  width: 150px;
  height: 150px;
  border-radius: 15px;
  background: linear-gradient(135deg, #f3f3f3, #ffebee);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  animation: sway 3s ease-in-out infinite;
}

@keyframes sway {
  0% { transform: rotate(2deg); }
  50% { transform: rotate(-2deg); }
  100% { transform: rotate(2deg); }
}

.dragon-image img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.progress-wrapper {
  width: 100%;
  max-width: 340px;
  background: #333;
  border-radius: 25px;
  padding: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
}

.progress-bar {
  height: 20px;
  border-radius: 15px;
  background: linear-gradient(90deg, #ffffff, #c4c4c4);
  width: 0%;
  transition: width 0.5s ease;
  box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
}

.imageDragon {
  width: 220px;
  align-items: center;
  justify-content: center;
  display: flex;
}

.dragon-stats {
  text-align: center;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 0 8px rgba(255, 140, 0, 0.7);
}

.dragon-controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

#dragonModal .modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.dragonImage {
  display: block;
  margin: 0 auto 18px auto;
  max-width: 130px;
  animation: bounce 1.5s ease infinite;
}

.small-btn {
  padding: 10px 14px;
  border-radius: 15px;
  border: none;
  cursor: pointer;
  background: linear-gradient(45deg, #ff1744, #ff8c00);
  color: white;
  font-weight: 700;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.small-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 77, 77, 0.6);
}

.small-btn:active {
  transform: translateY(1px);
}


@media (max-width: 600px) {
  .container, .container2, .transferHistory, .modal-content, .modal-content-dragon {
    width: 95%;
    padding: 15px;
  }

  .dragon-image {
    width: 120px;
    height: 120px;
  }

  .progress-wrapper {
    max-width: 280px;
  }

  .buttonSend, button {
    font-size: 14px;
    padding: 10px;
  }

  h2, h3 {
    font-size: 18px;
  }

  .info {
    font-size: 1.4rem;
  }

  .LyceumLogo {
    width: 90px;
    height: 24px;
  }

  .SendLogo {
    width: 45px;
    height: 45px;
  }
}
  </style>
</head>

<body>

  
  <div class="container">
    <div class="horizontal">
      <h3>Prime Card</h3>
      <h2 class="USDFont" id="welcomeMessage">Loading...</h2>
    </div>

    <br>
    <div class="info2">
      <span id="cardNumber" class="cardNumber">•••• •••• •••• ••••</span>
      
    </div>
    <br>
    <div class="info">
      <span class="USDFont">$</span>
      <span class="USDFont" id="balance">0</span>
    </div>
  </div>

  <div class="container2">
    <button id="openModalButton">
      <img class="SendLogo" src="Logos/ControlPanel/send (1).png" alt="">
    </button>
    
    <button id="openDragonButton">
      <img class="SendLogo" src="DragonArts/levelUpLogo.png" alt="">
    </button>
  </div>

  <div class="transferHistory">
    <h3>Transfer History</h3>
  </div>

  <div id="shopModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Shop</span>
        <div class="modal-close" id="closeShopModalButton">&times;</div>
      </div>
      <div id="productList"></div>
    </div>
  </div>

  <div id="dragonModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
        <img src="DragonArts/Egg.png" alt="Dragon Icon" style="width: 60px; margin-bottom: 0;">
        <h5 style="margin:0;">Dragon menu 🐉</h5>
        <div class="modal-close" id="closeDragonModal" style="margin-left:10px;">&times;</div>
      </div>

      <div class="dragon-area" id="dragonArea">
        <button id="createDragonBtn" class="small-btn" style="margin-top:12px;">Create Dragon</button>
        <div id="dragonUI" style="width:100%; display:none;">
          <div class="dragon-image" id="dragonImage">
            <img src="DragonArts/Egg.png" alt="Dragon Icon" style="width: 300px; margin-bottom: 15px;">
          </div>
          <div class="dragon-stats">
            <div id="dragonLevel">Level: —</div>
            <div id="dragonXP">XP: 0 / 500</div>
          </div>
          <div class="progress-wrapper">
            <div id="dragonProgress" class="progress-bar" style="width:0%"></div>
          </div>
          <div class="dragon-controls">
            <button id="debugAddXP" class="small-btn" style="display:none;">+100 XP (debug)</button>
            <button id="hatchBtn" class="small-btn" style="display:none;">Force Hatch (debug)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="productDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-close" id="closeProductDetail">&times;</div>
      <img id="detailImage" src="" alt="Product" style="width:100%; border-radius: 15px; margin-bottom: 15px;">
      <h5 id="detailName"></h5>
      <p id="detailDescription"></p>
      <h5 id="detailPrice"></h5>
      <button id="buyButton" class="buttonSend">Придбати</button>
    </div>
  </div>

  <div id="transactionModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="modal-close" id="closeTransactionModal">&times;</div>
      <img src="Logos/ControlPanel/send (1).png" alt="" style="width: 150px; margin-bottom: 20px;">
      <h2 id="txAmount" style="font-size: 28px; margin-bottom: 15px; color: #333;"></h2>
      <h3 id="txFrom" style="margin-bottom: 10px; color: #555;"></h3>
      <p id="txTime" style="color: #383838; font-size: 14px;"></p>
    </div>
  </div>

  <div id="transferModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Send Money</span>
        <div class="modal-close" id="closeModalButton">&times;</div>
      </div>
      <form id="transferForm">
        <label for="targetCard">Номер карти:</label>
        <input type="text" id="targetCard" maxlength="16" placeholder="Enter 16-digit card" required />
        <label for="amount">Сума переказу:</label>
        <input type="number" id="amount" min="0.01" step="0.01" placeholder="Enter amount" required />
        <button class="buttonSend" type="submit">Send</button>
      </form>
    </div>
  </div>

  <script type="module">

    import { auth, db } from './Scripts/firebase.js';
    import {
      doc,
      getDoc,
      collection,
      getDocs,
      updateDoc,
      addDoc,
      serverTimestamp,
      query,
      where,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const ADMIN_ID = 6291318550;
    const discordWebhookUrl = "https://discord.com/api/webhooks/1418546486681145434/emWkQYRc5puI-fGDJD9sG24pYt-3B3_YZV2GHrr1Hd7cA9g1OLbWdNTsQZ1vZX9t3VaR";

    const productList = document.getElementById("productList");
    const productDetailModal = document.getElementById("productDetailModal");
    const detailImage = document.getElementById("detailImage");
    const detailName = document.getElementById("detailName");
    const detailDescription = document.getElementById("detailDescription");
    const detailPrice = document.getElementById("detailPrice");
    const buyButton = document.getElementById("buyButton");
    let selectedProduct = null;


    async function loadProducts() {
      try {
        const productsSnapshot = await getDocs(collection(db, "products"));
        const products = [];
        productsSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          products.push({ id: docSnap.id, ...data });
        });
        return products;
      } catch (error) {
        console.error("Помилка завантаження товарів:", error);
        alert("Помилка завантаження товарів!");
        return [];
      }
    }

   
    async function displayProducts() {
      productList.innerHTML = "";
      const products = await loadProducts();
      
      if (products.length === 0) {
        productList.innerHTML = "<p style='color:#333; text-align:center;'>Немає товарів у магазині.</p>";
        return;
      }

      products.forEach(prod => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #ccc";
        div.style.cursor = "pointer";

        div.innerHTML = `
          <img src="${prod.image || 'Logos/Shop/default.png'}" style="width:60px; height:60px; border-radius:10px; margin-right:10px;">
          <div>
            <h4 style="margin:0; color:#333;">${prod.name}</h4>
            <p style="margin:0; font-size:14px; color:#655;">${prod.description}</p>
            <strong style="color:#000;">${prod.price} HOT</strong>
          </div>
        `;

        div.addEventListener("click", () => {
          selectedProduct = prod;
          detailImage.src = prod.image || 'Logos/Shop/default.png';
          detailName.innerText = prod.name;
          detailDescription.innerText = prod.description;
          detailPrice.innerText = `${prod.price} HOT`;
          productDetailModal.style.display = "flex";
        });

        productList.appendChild(div);
      });
    }

  
   
    document.getElementById("closeProductDetail").addEventListener("click", () => {
      productDetailModal.style.display = "none";
    });

    buyButton.addEventListener("click", async () => {
      if (!selectedProduct) return;

      const userRef = doc(db, "users", auth.currentUser.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        alert("Помилка: профіль не знайдений!");
        return;
      }

      const userData = userSnap.data();

      if (userData.balance < selectedProduct.price) {
        alert("Недостатньо коштів!");
        return;
      }

      await updateDoc(userRef, {
        balance: userData.balance - selectedProduct.price
      });

      await addDoc(collection(db, "transfers"), {
        from: userData.username,
        to: `Shop (${selectedProduct.name})`,
        amount: selectedProduct.price,
        timestamp: serverTimestamp(),
        type: "shop"
      });

      const discordPayload = {
        embeds: [
          {
            title: "🛒 Нове замовлення",
            description: `**Покупець:** ${userData.username}\n**Товар:** ${selectedProduct.name}\n**Ціна:** ${selectedProduct.price} HOT\n**Артикул:** ${selectedProduct.article}`,
            color: 0x4CAF50,
            timestamp: new Date().toISOString()
          }
        ]
      };

      fetch(discordWebhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(discordPayload)
      });

      alert("Покупка успішна!");
      location.reload();
    });

    
    const DRAGON_STAGE_IMAGES = [
      "DragonArts/Egg.png",
      "DragonArts/Stage1.png",
      "DragonArts/Stage2.png",
      "DragonArts/Stage3.png",
      "DragonArts/Stage4.png",
      "DragonArts/Stage5.png"
    ];
    const MAX_DRAGON_LVL = 5; 


    function xpThresholdForLevel(lvl) {
      return 500 * Math.pow(2, lvl);
    }

    const createDragonBtn = document.getElementById("createDragonBtn");
    const dragonModal = document.getElementById("dragonModal");
    const openDragonButton = document.getElementById("openDragonButton");
    const closeDragonModal = document.getElementById("closeDragonModal");
    const dragonUI = document.getElementById("dragonUI");
    const dragonImage = document.getElementById("dragonImage").querySelector("img");
    const dragonLevelEl = document.getElementById("dragonLevel");
    const dragonXPEl = document.getElementById("dragonXP");
    const dragonProgress = document.getElementById("dragonProgress");
    const debugAddXP = document.getElementById("debugAddXP");
    const hatchBtn = document.getElementById("hatchBtn");

    let currentUserDocRef = null;
    let unsubscribeDragonListener = null;

    async function createDragonForUser(userUid, username) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        alert("Профіль не знайдено.");
        return;
      }
      const userData = userSnap.data();

      if (userData.dragon && typeof userData.dragon === "object") {
        alert("У вас вже є дракон!");
        return;
      }

      const dragonObj = {
        xp: 0,
        lvl: 0,
        createdAt: serverTimestamp()
      };

      await updateDoc(userRef, {
        dragon: dragonObj
      });

      alert("Дракон створений! Починається відлік XP (0/500).");
    }

    function renderDragonUI(dragon) {
      if (!dragon) {
        dragonUI.style.display = "none";
        createDragonBtn.style.display = "inline-block";
        return;
      }

      createDragonBtn.style.display = "none";
      dragonUI.style.display = "block";

      const lvl = typeof dragon.lvl === "number" ? dragon.lvl : 0;
      let xp = typeof dragon.xp === "number" ? dragon.xp : 0;

      const nextThreshold = xpThresholdForLevel(lvl);
      const progressPercent = Math.min(100, Math.round((xp / nextThreshold) * 100));

      const stageIndex = Math.min(lvl, MAX_DRAGON_LVL);
      const imgPath = DRAGON_STAGE_IMAGES[stageIndex] || DRAGON_STAGE_IMAGES[0];

      dragonImage.src = imgPath;
      dragonLevelEl.innerText = `Level: ${lvl} ${lvl === 0 ? "(egg)" : ""}`;
      dragonXPEl.innerText = `XP: ${xp} / ${nextThreshold}`;
      dragonProgress.style.width = progressPercent + "%";

      if (lvl >= MAX_DRAGON_LVL) {
        dragonXPEl.innerText = `XP: ${xp} (MAX)`;
        dragonProgress.style.width = "100%";
      }
    }

    function watchUserDragon(userUid) {
      if (unsubscribeDragonListener) {
        unsubscribeDragonListener();
        unsubscribeDragonListener = null;
      }
      currentUserDocRef = doc(db, "users", userUid);
      unsubscribeDragonListener = onSnapshot(currentUserDocRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        renderDragonUI(data.dragon);
      });
    }

    async function normalizeDragonLevels(userUid) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();
      if (!data.dragon) return;

      let { xp = 0, lvl = 0 } = data.dragon;
      let changed = false;

      while (lvl < MAX_DRAGON_LVL) {
        const threshold = xpThresholdForLevel(lvl);
        if (xp >= threshold) {
          xp = xp - threshold;
          lvl = lvl + 1;
          changed = true;
        } else break;
      }

      if (changed) {
        await updateDoc(userRef, {
          "dragon.xp": xp,
          "dragon.lvl": lvl,
          "dragon.lastLevelUpAt": serverTimestamp()
        });
      }
    }

    async function addXPtoDragon(userUid, amount) {
      const userRef = doc(db, "users", userUid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();
      if (!data.dragon) {
        alert("Дракон не створено.");
        return;
      }
      const newXP = (data.dragon.xp || 0) + amount;
      await updateDoc(userRef, {
        "dragon.xp": newXP
      });
      await normalizeDragonLevels(userUid);
    }

    openDragonButton.addEventListener('click', () => {
      dragonModal.style.display = 'flex';
    });
    closeDragonModal.addEventListener('click', () => {
      dragonModal.style.display = 'none';
    });

    createDragonBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) { alert("Спочатку увійдіть."); return; }
      await createDragonForUser(user.uid);
    });

    debugAddXP.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      await addXPtoDragon(user.uid, 100);
    });
    hatchBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      await addXPtoDragon(user.uid, 10000);
    });

    async function loadTransfers(username) {
      const transferHistoryDiv = document.querySelector(".transferHistory");
      transferHistoryDiv.innerHTML = "<h3>Transfer History</h3>";

      const incomingQuery = query(collection(db, "transfers"), where("to", "==", username));
      const outgoingQuery = query(collection(db, "transfers"), where("from", "==", username));

      const [incomingSnapshot, outgoingSnapshot] = await Promise.all([getDocs(incomingQuery), getDocs(outgoingQuery)]);

      const transfers = [];

      incomingSnapshot.forEach(docSnap => { let data = docSnap.data(); data.type = "incoming"; transfers.push(data); });
      outgoingSnapshot.forEach(docSnap => { let data = docSnap.data(); data.type = "outgoing"; transfers.push(data); });

      transfers.sort((a, b) => {
        const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
        const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
        return timeB - timeA;
      });

      transfers.forEach(transfer => {
        const p = document.createElement("p");
        p.classList.add("transfer-message");

        if (transfer.type === "incoming") {
          p.classList.add("incoming");
          p.innerHTML = `${transfer.from} sent you ${transfer.amount}  <span class="USDFont">$</span>`;

          p.addEventListener("click", () => {
            document.getElementById("transactionModal").style.display = "flex";
            document.getElementById("txAmount").innerText = `${transfer.amount} HOT`;
            document.getElementById("txFrom").innerText = `Від: ${transfer.from}`;
            document.getElementById("txTime").innerText = transfer.timestamp
              ? `Час: ${transfer.timestamp.toDate().toLocaleString()}`
              : "Час: неизвестно";
          });
        } else {
          p.classList.add("outgoing");
          p.innerHTML = `You sent ${transfer.amount}  <span class="USDFont">$</span> to ${transfer.to}`;
        }

        transferHistoryDiv.appendChild(p);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;
      const data = userSnap.data();

      document.getElementById('welcomeMessage').innerText = `${data.username}`;
      document.getElementById('balance').innerText = `${data.balance.toFixed(2)}`;
      document.getElementById('cardNumber').innerText = data.cardNumber.replace(/(\d{4})(?=\d)/g, "$1 ");

      document.getElementById('openModalButton').addEventListener('click', () => document.getElementById('transferModal').style.display = 'flex');
      document.getElementById('closeModalButton').addEventListener('click', () => document.getElementById('transferModal').style.display = 'none');
      document.getElementById('closeShopModalButton').addEventListener('click', () => document.getElementById('shopModal').style.display = 'none');
      document.getElementById("closeTransactionModal").addEventListener("click", () => {
        document.getElementById("transactionModal").style.display = "none";
      });

      loadTransfers(data.username);

      document.getElementById('transferForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const targetCard = document.getElementById('targetCard').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        if (targetCard.length !== 16 || isNaN(amount) || amount <= 0) { alert('Invalid input'); return; }

        const usersSnap = await getDocs(collection(db, "users"));
        let recipientId = null, recipientBalance = 0;
        usersSnap.forEach(docSnap => {
          const userDataSnap = docSnap.data();
          if (userDataSnap.cardNumber === targetCard) {
            recipientId = docSnap.id;
            recipientBalance = userDataSnap.balance;
          }
        });
        if (!recipientId) { alert("Card not found!"); return; }
        if (data.balance < amount) { alert("Insufficient funds!"); return; }

        await updateDoc(doc(db, "users", user.uid), { balance: data.balance - amount });
        await updateDoc(doc(db, "users", recipientId), { balance: recipientBalance + amount });

        const recipientRef = doc(db, "users", recipientId);
        const recipientSnap = await getDoc(recipientRef);
        if (recipientSnap.exists()) {
          const recipientData = recipientSnap.data();
          await addDoc(collection(db, "transfers"), {
            from: data.username,
            to: recipientData.username,
            amount: amount,
            timestamp: serverTimestamp()
          });
        }

        alert("Transfer successful!");
        location.reload();
      });

      watchUserDragon(user.uid);
      await normalizeDragonLevels(user.uid);

      if (user.uid === String(ADMIN_ID) || user.uid === ADMIN_ID) {
        debugAddXP.style.display = "inline-block";
        hatchBtn.style.display = "inline-block";
      } else {
        debugAddXP.style.display = "none";
        hatchBtn.style.display = "none";
      }
    });
  </script>

</body>

</html>